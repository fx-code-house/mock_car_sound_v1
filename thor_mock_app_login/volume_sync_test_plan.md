# Thor音量同步修正测试方案

## 关键修正内容

### 1. 命令格式修正
- **之前**: 使用大端序格式 `(value >> 8) & 0xFF, value & 0xFF`
- **现在**: 使用小端序格式 `value & 0xFF, (value >> 8) & 0xFF`
- **依据**: 你的日志显示命令59使用小端序 `15,0,59,0,3,0,1,0,0,0,2,0,0,0,3,0,1`

### 2. 命令67格式（小端序）
```
示例: 设置包ID 27, 主音量80%
数据: 15,0,67,27,0,1,0,0,0,1,0,0,0,80,0
解析:
- 长度: 15
- 命令: 0,67 (命令67)
- 包ID: 27,0 (小端序，值27)
- 版本: 1,0 (小端序，值1)
- 模式: 0,0 (小端序，值0)
- 数量: 1,0 (小端序，值1)
- 规则ID: 0,0 (小端序，值0=主音量)
- 规则值: 80,0 (小端序，值80)
```

## 测试步骤

### 第1步: 安装修正后的应用
```bash
adb install app/build/outputs/apk/debug/app-debug.apk
```

### 第2步: 同时运行两个应用
1. 启动官方Thor应用
2. 启动我们的mock应用
3. 确保两个应用都连接到同一个Thor设备

### 第3步: 测试音量同步
1. **在mock应用中调整音量**
   - 调整主音量从80%到60%
   - 调整空闲音从50%到40%
   - 观察官方Thor应用是否同步显示

2. **在官方应用中调整音量**
   - 调整引擎音效从40%到70%
   - 观察mock应用是否同步显示

### 第4步: 测试重连保持
1. 断开Thor设备连接
2. 重新连接设备
3. 检查mock应用是否保持之前的音量设置

## 预期结果

### ✅ 成功标准
- [ ] Mock应用调整音量后，官方应用立即同步显示
- [ ] 官方应用调整音量后，mock应用能检测到变化
- [ ] 重连设备后，音量设置保持不变
- [ ] 无错误日志或崩溃

### ❌ 可能的问题
- 如果仍然不同步，可能需要调整其他参数：
  - versionId的值（当前使用1）
  - mode的值（当前使用0）
  - 整个数据结构

## 调试方法

### 方法1: 查看应用日志
```bash
adb logcat | grep -E "(ThorBluetooth|SoundPackage)"
```

### 方法2: 简化测试
如果完整测试复杂，可以先验证：
1. 命令是否正确发送（查看日志中的十六进制数据）
2. 设备是否正确响应（无错误返回码）

## 命令格式对比

### 修正前（大端序）
```
主音量80%: 15,0,67,0,27,0,1,0,0,0,1,0,0,0,80
十六进制: 0F 00 43 00 1B 00 01 00 00 00 01 00 00 00 50
```

### 修正后（小端序）
```
主音量80%: 15,0,67,27,0,1,0,0,0,1,0,0,0,80,0
十六进制: 0F 00 43 1B 00 01 00 00 00 01 00 00 00 50 00
```

关键差异在于多字节值的字节序：
- PackageId 27: `00 1B` → `1B 00`
- Volume 80: `00 50` → `50 00`

## 下一步计划

1. 测试修正后的应用
2. 根据测试结果调整参数
3. 验证完全同步功能
4. 如果成功，文档化最终解决方案